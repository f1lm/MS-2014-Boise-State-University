define(["jquery","version!fly/managers/debug","version!fly/utils/string-helper","version!fly/utils/string-vars","version!fly/utils/object-helper","version!fly/components/social-links"],function(e,t,n,r,i){var s=e.support.touch?"vclick":"click",o=t.init("socialCounts");e.widget("fly.socialCounts",e.fly.socialLinks,{options:{url:null,facebookKey:null,showZeros:!1,countType:"human",containerClass:"social-count",containerTemplate:"<span></span>",loadingClass:"loading",loadedClass:"loaded",googleButtonType:"small",showTotal:!1,totalContainerSelector:".social-count-total",location:null,timeout:1e3},selectorId:"counts",total:0,countTotals:0,services:{facebook:"http://api.ak.facebook.com/restserver.php?v=1.0&method=links.getStats&urls={url}&format=json",twitter:"http://cdn.api.twitter.com/1/urls/count.json?url={url}",linkedin:"http://www.linkedin.com/countserv/count/share?url={url}",delicious:"http://feeds.delicious.com/v2/json/urlinfo/data?url={url}",pinterest:"http://api.pinterest.com/v1/urls/count.json?url={url}"},responseKeys:{facebook:"like_count",twitter:null,reddit:"score",linkedin:null,delicious:"total_posts",stumbleupon:"views",pinterest:null,googleplus:null},responseObj:{facebook:function(e){return e[0]},delicious:function(e){return e[0]},reddit:function(e){return e.children.length>0?e.children[0]:null}},requestDataType:{},requestData:{},_create:function(){var e=this.options;this._super("_create"),this.url=e.url||window.location.href,this.$links=this.$element.find("[data-"+this.selectorId+"]"),this._setupRequests()},_setupRequests:function(){if(this.$links.length<=0)return o.log("Error: No links found in element.",this.$element),!1;var t=this,r=this.$links.length,i;this.$links.each(function(s,u){var a=e(u),f=a.data(t.popupId).toLowerCase(),l=t._getService(f),c="_load"+n.capitalize(f),h=s===r-1?!0:!1,p=0;t._loader("add",a),l?(t.load(f,l),i="socialcountsloaded"):e.isFunction(t[c])?t[c]():(o.log("Error: No service or custom function found for "+f,t.$element),t._loader("remove",a)),t.$element.on(i,function(e,n){p=n.count||0,t.total+=p,t._setTotal(r)})})},load:function(t,n){if(t.length<=0||n.length<=0)return o.log("Error: Service url or name not defined"),!1;var r=this,s=this.responseKeys[t]||"count",u=this.requestDataType[t]||"jsonp",a=this.requestData[t]||{};o.log("Requesting: "+t+"("+n+")"),e.ajax({dataType:u,url:n,data:a,timeout:r.options.timeout}).done(function(n,o,u){n=e.isFunction(r.responseObj[t])?r.responseObj[t](n):n;var a=i.deepFind(n,s)||{};r.setContent(t,a)}).fail(function(e,i,s){o.log("Error: "+t+"("+n+")"+" response failed",e,i),r.setContent(t,{})})},_getService:function(e){var t=this.services[e],n=this._getServiceData();return t=r.compile(t,n,["urlencode"]),t},_getServiceData:function(){var t=this.options;return e.extend({url:this.url,googleplusKey:t.googleplusKey,facebookKey:t.facebookKey},t.data)},_loadGoogleplus:function(){var e=this.options,t='<div class="g-plusone" data-size="'+e.googleButtonType+'" data-href="'+this.url+'" data-count="true" data-callback="handleGooglePlusCallback"></div>',n=this._getLinkEl("googleplus"),r=this;n.html(t),window.handleGooglePlusCallback=function(e){var t=e.state=="on"?"plusone":"rmvplusone"},require(["https://apis.google.com/js/plusone.js"],function(){window.handleGooglePlusCallback=function(e){var t=e.state=="on"?"plusone":"rmvplusone";r._trigger(null,{button:"googleplus",type:t})}.bind(this),r._setupLoadEvent({el:n,name:"googleplus"})})},setContent:function(t,n){var r=this.options,i="[class="+r.containerClass+"]",s,o,u=0;return s=this._getLinkEl(t),o=s.find(i),o=o.length?o:e(r.containerTemplate).addClass(r.containerClass).addClass(r.containerClass+"-"+t).insertAfter(s).before(" "),r.showZeros&&typeof n=="object"&&(n="0"),typeof n!="object"&&(u=parseInt(n,10),r.countType==="human"&&(n=this._getNormalizedCount(u)),o.text(n),s.addClass(r.loadedClass)),this._loader("remove",s),this._setupLoadEvent({el:s,name:t,count:u,type:"countSet"}),!0},_setTotal:function(e){var t=this.options,n=this.$element.find(t.totalContainerSelector),r=t.countType==="human"?this._getNormalizedCount(this.total):this.total;this.countTotals++;if(n.length<0)return o.log("Error: total container not found. Selector: "+t.totalContainerSelector),!1;n.text(r),this.countTotals===e&&(this._setupLoadEvent({el:this.$element,type:"totalSet"}),this.$element.addClass(t.loadedClass))},_setupLoadEvent:function(t){t=t||{};var n=this.options.location;n&&e.extend(t,{location:n}),this._trigger("loaded",null,t)},_getLinkEl:function(t){var n=this,r;return this.$links.filter(function(i){var s=e(this),o=s.attr("data-"+n.popupId).toLowerCase();return r=o===t?e(this):!1,r})},_getNormalizedCount:function(e){return e>=1e9?e=(e/1e9).toFixed(2)+"B":e>=1e6?e=(e/1e6).toFixed(2)+"M":e>=1e3&&(e=(e/1e3).toFixed(1)+"K"),e},_loader:function(e,t){var n=this.options;t=t||this.$element,e==="add"?t.addClass(n.loadingClass):t.removeClass(n.loadingClass)}})})
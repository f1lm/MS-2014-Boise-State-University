define(["jquery","version!fly/managers/debug","managers/user","version!fly/components/livefyre-conversation"],function(e,t,n){t=t.init("livefyreTR");var r=window.trPageVars.user,i=null;e.widget("tr.livefyreConversation",e.fly.livefyreConversation,{options:{globalConfig:{strings:{editProfile:"My Profile",follow:"+ Follow Conversation",listenerCount:"person following",listenerCountPlural:"people following",signIn:"Log In",signOut:"Log Out",sortLabel:"Sort by:",sortSeparator:" | ",unfollow:"- Unfollow"}},commentStreamConfigs:{datetimeFormat:{minutesUntilAbsoluteTime:1440},disableAvatars:!1,postToButtons:["fb","tw","li"],anonymousFlaggingEnabled:!1},commentCountUpdated:function(e,n){t.log("Comment count updated to "+n)}},count:0,authDelegate:{login:function(e){t.log("authDelegate login"),i=e,n.showModal("login",{showUserName:1,regSource:"comments"})},logout:function(e){t.log("authDelegate logout"),window.location="/user/logout"},editProfile:function(e,n){t.log("authDelegate editProfile: ",n),window.location.href="/members/edit/"},viewProfile:function(e,n){t.log("authDelegate editProfile: ",n);var r=n.id;regId=r.match(/^(.)*(?=@)/)[0],window.location.href="/members/profile/"+regId+"/"}},events:{initialRenderComplete:function(e){t.log("Conversation rendered",e),this._showComments()},commentPosted:function(e){t.log("Comment posted",e)},commentFlagged:function(e){t.log("Comment flagged",e)},commentLiked:function(e){t.log("Comment liked",e)},commentShared:function(n){t.log("Comment shared",n);var r=e("#fyre-message-"+n.targetId),i="This comment was shared";n.sharedToFacebook?(i+=" to <strong>Facebook</strong>",n.sharedToTwitter&&(i+=" and <strong>Twitter</strong>")):n.sharedToTwitter&&(i+=" to <strong>Twitter</strong>");if(r){var s=e("<div/>",{"class":"livefyreShareNotification",html:i});e(".fyre-comment-wrapper",r).append(s),s.fadeIn(),window.setTimeout(function(e){e.fadeOut()},5e3,s)}},commentCountUpdated:function(e){t.log("Comment count updated",e),this.count=e,this._showComments()},userLoggedIn:function(e){t.log("User is logged in"),this._showDelete(e)}},_create:function(e){var t=this,n=t.options;this._super("_create"),this._setupUserEvents()},_setupUserEvents:function(){var r=this;n.registerEvents({loginSuccess:function(n,i){t.log("user logged in"),r._authenticateUser(),i!=undefined&&i.isLoggedIn==1&&(console.log("User is logged in"),e(".fyre-flag-link").css({visibility:"visible",position:"relative"}))},registerSuccess:function(){t.log("user registered"),r._authenticateUser()},logutSuccess:function(){t.log("user logged out")}})},_authenticateUser:function(){e.ajax({url:"/livefyre/user-token/xhr/"}).done(function(e){e.userToken&&e.status!=="fail"&&(fyre.conv.login(e.userToken),i?i.success():t.log("No login handler"))}).fail(function(){window.location.reload()})},_showComments:function(){this.count>0},_showDelete:function(e){e.isModerator}})})
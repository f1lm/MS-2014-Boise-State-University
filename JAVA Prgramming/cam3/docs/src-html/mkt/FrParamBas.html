<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <title>Source code of the sample server application Cookbook</title>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="Author" content="Christoph Mueller">
   <meta name="GENERATOR" content="Mozilla/4.5 [de] (WinNT; I) [Netscape]">
   <meta http-equiv="KEYWORDS" content="Source code, Server application, sample, Java, Linux, MySQL">
   <meta name="Audience" content="IT, Software engineers, Programmer">
   <meta name="Content-Language" content="en-US">
   <meta http-equiv="AUTHOR" content="Christoph Mueller">
   <meta name="COPYRIGHT" content="Christoph Mueller">
   <meta http-equiv="Reply-to" content="CMueller@de.must.de">
   <meta name="PUBLISHER" content="Christoph Mueller">
   <meta name="PUBLISHER-EMAIL" content="CMueller@de.must.de">
   <meta name="CREATION" content="Wdn, 13 Jun 2001">
   <meta name="REVISON" content="Wdn, 15 Aug 2001">
   <meta name="ROBOTS" content="INDEX, FOLLOW">
   <meta name="REVISIT-AFTER" content="28 days">
   <meta name="Description" content="Create reliable database applications easyly - swing and browser by identical concept">
   <meta name="KeyWords" content="Source code, Server application, sample, Java, Linux, MySQL">
</head>
<body background="indtextb.jpg">

<pre>
<h1>FrParamBas</h1>
package mkt;

import de.must.wuic.*;
import de.must.dataobj.ConnectionHolder;
import javax.swing.*;
import java.awt.*;
import java.awt.event.*;

/**
 * @author Christoph Mueller
 */
public final class FrParamBas extends LocalParameterDialog implements ActionListener, ItemListener {

  private boolean isToConnect;
  private int previousAccessType;
  private String previousDataSourceName;
  private String previousUrl;
  private String previousDriver;
  private String previousUser;
  private String previousPassword;
  private JFrame dialogOwnerFrame;
  private JFileChooser fileDialog1;

  private ButtonGroup cgAccessType = new ButtonGroup();
  private JRadioButton cbOdbc = new JRadioButton("ODBC", true);
  private JRadioButton cbOther = new JRadioButton("Andere", false);
  private MustTextField tfOdbcName;
  private MustChoice odbcChoice = new MustChoice();
  private MustTextField tfUrl;
  private MustTextField tfDriver;
  private MustTextField tfUser;
  private MustPasswordField tfPassword;
  private MustButton buttonConnect = new MustButton("Verbindung testen", "BtnConnect", this);

  private MustTextField tfBrowserPath;
  private MustButton buttonBrowseBp = new MustButton("Durchsuchen", "BtnBrowseBp", this);
  private JRadioButton jRadioButtonXy = new JRadioButton();
  private ButtonGroup cGSL = new ButtonGroup();
  private JRadioButton jRadioButtonSecL1 = new JRadioButton("Jeder darf alles", true);
  private JRadioButton jRadioButtonSecL2 = new JRadioButton("Benutzerregistrierung", false);
  private JRadioButton jRadioButtonSecL3 = new JRadioButton("Sachgebietstrennung", false);

  private MustTextField userName;

  public FrParamBas(Frame OwnerFrame) {
    super(OwnerFrame);
    setTitle("Basis-Parameter");

    cgAccessType.add(cbOdbc);
    cgAccessType.add(cbOther);
    cGSL.add(jRadioButtonSecL1);
    cGSL.add(jRadioButtonSecL2);
    cGSL.add(jRadioButtonSecL3);

    newPanel("Datenbank");
    currentAttributeList.append("Zugriffsart", cbOdbc);
    currentAttributeList.append(cbOther);
    /* if (Main.getSecurityLevel() == Main.SECURITY_NORMAL) {
      cbOther.setEnabled(false);
      cbOther.setToolTipText("Die Standardversion unterstützt nur ODBC");
    } */
    tfOdbcName = createTextField("Datenquellen-Name", 20);
    tfOdbcName.setToolTipText("Wie in Systemsteuerung, ODBC32 definiert");
    odbcChoice.setToolTipText("Zur Zeit verfügbare ODBC-Quellen");
    currentAttributeList.append(odbcChoice);
    tfUrl = createTextField("URL", 30);
    tfDriver = createTextField("Treiber-Name", 30);
    tfUser = createTextField("Benutzer", 20);
    tfUser.setToolTipText("Zur Anmeldung an der Datenbank");
    currentAttributeList.append(new JLabel("(falls erforderlich)"));
    tfPassword = createPasswordField("Kennwort", 20);
    tfPassword.setToolTipText("Zur Anmeldung an der Datenbank");
    currentAttributeList.append(new JLabel("(falls erforderlich)"));
    currentAttributeList.append(buttonConnect);

    newPanel("Anwendungspfade");
    tfBrowserPath = createTextField("Browser", 50);
    currentAttributeList.append(buttonBrowseBp);

    newPanel("Sonstiges");
    userName = createTextField("Benutzer-Name", 20);
    userName.setToolTipText("Manueller Eintrag für Betriebssysteme, die keinen Benutzernamen erfragen");

    switch (ParamLoc.getAccessType()) {
    case ConnectionHolder.ODBC_ACCESS:
      cbOdbc.setSelected(true);
      break;
    case ConnectionHolder.OTHER_ACCESS:
      cbOther.setSelected(true);
      break;
    }

    previousAccessType = ParamLoc.getAccessType();
    previousDataSourceName = ParamLoc.getOdbcName();
    previousUrl = ParamLoc.getUrl();
    previousDriver = ParamLoc.getDriverName();
    previousUser = ParamLoc.getDbUser();
    previousPassword = ParamLoc.getDbPassword();

    tfOdbcName.setText(ParamLoc.getOdbcName());
    odbcChoice.addItems(Main.getOdbcNames());
    odbcChoice.setSelectedItem(ParamLoc.getOdbcName());
    tfUrl.setText(ParamLoc.getUrl());
    tfDriver.setText(ParamLoc.getDriverName());
    tfUser.setText(ParamLoc.getDbUser());
    tfPassword.setText(ParamLoc.getDbPassword());
    tfBrowserPath.setText(ParamLoc.getBrowserPath());
    userName.setText(ParamLoc.getUserName());

    serveCbDependence();

    cbOdbc.addItemListener(this);
    cbOther.addItemListener(this);
    odbcChoice.addItemListener(new ItemListener() {
      public void itemStateChanged(ItemEvent e) {
        tfOdbcName.setText((String)odbcChoice.getSelectedItem());
      }
    });

    creationEnding();
  }

  public void itemStateChanged(ItemEvent e) {
    serveCbDependence();
  }

  private void serveCbDependence() {
    tfOdbcName.setEnabled(cbOdbc.getModel().isSelected());
    odbcChoice.setEnabled(cbOdbc.getModel().isSelected());
    tfUrl.setEnabled(cbOther.getModel().isSelected());
    tfDriver.setEnabled(cbOther.getModel().isSelected());
  }

  public void actionPerformed(ActionEvent e) {
    String actCommand = e.getActionCommand();
    statusLabel.setText("");
    if (actCommand.equals("BtnConnect")) {
      setMessage("Teste Verbindung ...");
      if (isConnectable()) {
        HelpConn.close();
        setMessageToKeep("Verbindung möglich.");
      }
      else setMessageToKeep("Verbindungtest nicht geglückt.");
    } else if (actCommand.equals("BtnBrowseBp")) {
      fileDialog1 = new JFileChooser();
      fileDialog1.setDialogTitle("Browser auswählen");
      if (fileDialog1.showOpenDialog(this) == JFileChooser.APPROVE_OPTION) tfBrowserPath.setText(fileDialog1.getSelectedFile().getPath());
    } else super.actionPerformed(e);
  }

  protected boolean isInputAccepted() {
    if (isToConnect() && !isConnectable()) {
      setMessageToKeep("Gewünschte Datenbankverbindung nicht akzeptiert");
      return false;
    }
    return true;
  }

  private boolean isToConnect() {
    boolean result = false;
    if (!Global.getInstance().mainConnectionHolder.isConnected()) result = true;
    if (cbOdbc.getModel().isSelected() && previousAccessType != 0) result = true;
    if (cbOther.getModel().isSelected() && previousAccessType != 1) result = true;
    if (!tfOdbcName.getText().equals(previousDataSourceName)) result = true;
    if (!tfUrl.getText().equals(previousUrl)) result = true;
    if (!tfDriver.getText().equals(previousDriver)) result = true;
    if (!tfUser.getText().equals(previousUser)) result = true;
    if (!tfPassword.getPasswordText().equals(previousPassword)) result = true;
    return result;
  }

  protected void act() {
    parmUpdate();
    if (isToConnect()) {
      MustFrame.closeAll();
      Global.getInstance().destroyGlobalDataObjects();
      Global.getInstance().closeMainConnection();
      HelpConn.close();
      Global.getInstance().invalidateConnections(); // to recreate it
      Global.getInstance().connectionSpecification = ParamLoc.getConnectionSpecification();
      Global.getInstance().createOrCheckConnections();
      TableCreator tableCreator = new TableCreator();
      tableCreator.createIfNecessary(ownerFrame);
      Global.getInstance().createGlobalDataObjects();
    }
    CurrentUser.loadAll(); // userName may have changed
  }

  private boolean isConnectable() {
    String url;
    String driverName;
    if (cbOdbc.getModel().isSelected()) {
      url = "jdbc:odbc:" + tfOdbcName.getText();
      driverName = "sun.jdbc.odbc.JdbcOdbcDriver";
      return isConnectable(url, driverName, tfUser.getText(), tfPassword.getPasswordText());
    }
    if (cbOther.getModel().isSelected()) {
      url = tfUrl.getText();
      driverName = tfDriver.getText();
      return isConnectable(url, driverName, tfUser.getText(), tfPassword.getPasswordText());
    }
    return false;
  }

  private void parmUpdate() {
    if (cbOdbc.getModel().isSelected()) ParamLoc.setAccessType(0);
    if (cbOther.getModel().isSelected()) ParamLoc.setAccessType(1);
    ParamLoc.setOdbcName(tfOdbcName.getText());
    ParamLoc.setUrl(tfUrl.getText());
    ParamLoc.setDriverName(tfDriver.getText());
    ParamLoc.setDbUser(tfUser.getText());
    ParamLoc.setDbPassword(tfPassword.getPasswordText());
    ParamLoc.setBrowserPath(tfBrowserPath.getText());
    ParamLoc.setUserName(userName.getText());
    ParamLoc.updateParam();
  }

}



</pre>

<hr WIDTH="100%">
<center> Source is part of the <a href="http://www.must.de/Jacompe.htm" TARGET="_top">Open Source Project Cameleon OSP</a></center>

</body>
</html>

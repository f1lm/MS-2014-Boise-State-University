/*! Autogenerate CrowdChat 2014-11-07 */
function checkGetPost(){var a=$("#getPost").val();if(a&&"0"!=a)if($("#"+a).length>0){scrollAndHighlight(a),postPaused=!0;var b=parseInt($("#numUpdates").val(),10);if(b&&b>0){var c=parseInt(b,10);showUpdateAlert(c)}changeSort("activity")}else static_alert("Could not find post, may be deleted or in previous chat.")}function processHighlights(){for(var a in highlightQueue)highlight(highlightQueue[a]);highlightQueue=[]}function extendTime(){$("#extendTimePrompt").appendTo("body").modal("show"),$("#confirmAddTime").off("click").on("click",function(){var a=+$("#addTimeInput").val();return 0>=a?(handle_alert({error:"Time to add must be greater than 0 minutes."}),void $("#extendTimePrompt").modal("hide")):(socket.emit("addTimeRequest",a),$("#extendTimePrompt").modal("hide"),toggle_edit($("#editButton")),void handle_alert("Time Extension Granted!"))})}function pauseOnScroll(){$(window).scrollTop()>2*$(window).height()&&(postPaused=!0,commentPaused=!0),$(window).scrollTop()+$(window).height()>$(document).height()-100&&loadMorePosts()}function loadMorePosts(){if(!loadingPosts){loadingPosts=!0;var a=$("div.post[id]").map(function(){return this.id}).get();a=a.join(","),$("#updates").val()&&(a+=","+$("#updates").val());var b={lastPost:a,sortBy:$("#sortByDropDown").attr("data-selected")};$.post("/chat/page/"+$("#archive_id").val(),b).done(function(a){var b=renderHTML("posts",a);-1!=b.indexOf('class="post"')?($("#post_divs").append(b),load_post_bindings(),initEmbdededContent("div#post_divs"),updateTimestamps()):$(window).off("scroll"),loadingPosts=!1})}}function updateSelectedContacts(){$("#numSelectedContacts").html($("#fullInviteModal input:checked").length+" ")}function loadContacts(a){if(!loadedServices[a]){var b=$("#"+a+"Contacts");b.html('<i class="fa fa-spinner fa-spin"></i> Loading Contacts...'),$.get("/user/contacts/"+a,function(c){var d=a.charAt(0).toUpperCase()+a.slice(1);if(c.error)return b.html("<a class='btn btn-primary' href='/auth/"+a+"'>Load "+d+" Contacts</a>"),void handle_alert(c);if(c.needOauth)return void b.html("<a class='btn btn-primary' href='/auth/"+a+"'>Load "+d+" Contacts</a>");if(b.html(""),loadedServices[a]=!0,c.forEach(function(c){var d='<div class="well" style="margin-bottom:2px;padding:2px;padding-left:10px">';d+='<input id="user" type="checkbox" name="user" value="'+c.screen_name+'">',d+="<img src="+c.image+' style="margin:0px 10px;width:30px;">',d+='<span style="margin-left:10px;margin-right:10px">';var e=c.link||"https://twitter.com/"+c.screen_name;d+='<a href="'+e+'" target="_blank"',"twitter"==a&&(d+=' data-toggle="tooltip", data-placement="top", title="'+c.description+'"'),d+=">"+c.user_name+" </a>","gmail"!=a&&(d+="("+c.screen_name+")"),d+="</span>",d+='<img class="pull-right" src="/img/'+a+'/logo.png" style="width:30px"></div>',b.append(d),$("input").click(updateSelectedContacts)}),0===c.length){var e='<div class="well" style="margin-bottom:2px;padding:2px;padding-left:10px">';e+="No contacts found.",b.append(e)}$("a").tooltip()})}}function resetInviteMessage(){var a=$("#share_url").val();$("#inviteMessage").val("I'm having a chat, join me "+a);var b=100-$("#inviteMessage").val().length;$("#inviteChars").html(b)}function sendAllInvites(){var a=$("#fullInviteModal input:checked").length;if(0>=a)return void handle_alert({error:"You must select someone to invite."});var b=$("#twitterContacts input:checked").length;if(b>20)return void handle_alert({error:"We can only send to 20 or fewer Twitter users."});var c=$("#inviteMessage").val();if(c.length<=0)return void handle_alert({error:"You must provide an invitation message."});var d=[];$("#twitterContacts input:checked").each(function(){d.push({type:"twitter",address:$(this).val()})}),$("#facebookContacts input:checked").each(function(){d.push({type:"facebook",address:$(this).val()})}),$("#gmailContacts input:checked").each(function(){d.push({type:"gmail",address:$(this).val()})});var e=$("#hash").val().toLowerCase(),f=($("span.hash").html(),$("#spot_id").val().toLowerCase(),$("#server").val().toLowerCase(),twttr.txt.getTweetLength(c)),g={contacts:d,message:c,messageLength:f,hash:e};$.post("/user/contacts/invite",g,function(a){return a.error?void handle_alert(a):(handle_alert("Invites sent successfully."),$("#fullInviteModal").modal("hide"),resetInviteMessage(),void $("#fullInviteModal input:checked").each(function(){$(this).attr("checked",!1)}))})}function populate_count_down(){var a=parseInt($("#datetime").val(),10);if($("#start_date")){var b=moment(a),c=(new Date).format("Z"),d=b.format("Do"),e=d.length-2;d=d.substr(0,e)+"<sup>"+d.substr(e)+"</sup>",$("#start_date").html("Begins "+b.format("dddd, MMMM ")+d+b.format(" YYYY")),$("#start_time").html(b.format("h:mm A ")+c)}}function pluralize(a,b){var c="";return b>0&&(c+=1==b?b+" "+a+" ":b+" "+a+"s "),c}function set_date(){var a=parseInt($("#datetime").val(),10),b=parseInt($("#duration").val(),10),c=new Date((new Date).getTime()+serverClientClockDrift),d=new Date(a),e=new Date(a+b),f=d,g="";c>d?e>c?(f=e,g+="<strong>Time Left </strong>",("pending"==mode||"active"==mode&&"upcoming"==$("#state").val())&&($("#state").val("live"),window.location.reload(),setTimeout(function(){static_alert("Please refresh page to begin, if it does not automatically refresh in next 5 seconds.","24px")},1e4)),mode="active"):(g+="<strong>Chat Ended on</strong> ",("active"==mode||"pending"==mode)&&setTimeout(function(){window.location.reload()},5e3),window.clearInterval(setDateID),mode="finished"):(g+="<strong>Chat Starts in </strong> ",mode="pending");var h=f.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),i={},j=(f-c)/1e3/60/60/24;i.Day=Math.floor(j);var k=(f-c)/1e3/60/60-24*i.Day;i.Hour=Math.floor(k);var l=(f-c)/1e3/60-1440*i.Day-60*i.Hour;i.Minute=Math.floor(l);var m=(f-c)/1e3-86400*i.Day-3600*i.Hour-60*i.Minute;if(i.Second=Math.round(m),c>d&&c>e)return h=moment(a+b).format("dddd, MMMM Do, YYYY"),g+=h,void $("#date").html('<h5 class ="heading">'+g+"</h5>");g+='<span class="count_down">';var n=0,o=["Day","Hour","Minute","Second"];o.forEach(function(a){if(2>n){var b=pluralize(a,i[a]);b.length>0&&(g+=b,n+=1)}}),g+="</span>",$("#date .heading").html(g)}function changeSort(a){var b=$("#sortByDropDown");b.find("span").html("Sorted by "+a),b.attr("data-selected",a),"votes"==a?b.addClass("btn-primary"):b.removeClass("btn-primary")}function loadLatest(a){return changeSort(a),$("a#sortByDropDown").attr("disabled","disabled"),$("#post_sort_loading").show(),"activity"==a?(postQueue.length+commentQueue.length<50&&renderAll(activityCache),resumePosts()):socket.emit("update_user",{sortBy:"votes"}),!1}function fixURL(){var a=$("#server").val(),b="chat/"+$("#archive_id").val();"true"==$("#hasHash").val()&&(b=$("#hash").val()),window.history&&window.history.replaceState?history.replaceState({},"chat","/"+b):window.location.replace(a+"/"+b)}function pullUpdates(){$("#infoBox").hide(),$("#updates").val(""),$("#numUpdates").val(""),loadLatest("activity")}function getSortingOrder(){return $("a#sortByDropDown").attr("data-selected")}function set_checkboxes(a,b,c){check_tweet=a,check_share=b,check_fbpost=c,$(".tweet_checkbox").prop("checked",a),$(".share_checkbox").prop("checked",b),$(".fbpost_checkbox").prop("checked",c)}function setup_hover_icons(){$(".twitter_reply").off("mouseover").on("mouseover",function(){$(this).attr("src","/img/twitter/reply_hover.png")}),$(".twitter_reply").off("mouseover").on("mouseout",function(){$(this).attr("src","/img/twitter/reply.png")}),$(".twitter_fav").off("mouseover").on("mouseover",function(){$(this).attr("src","/img/twitter/fav_hover.png")}),$(".twitter_fav").off("mouseover").on("mouseout",function(){$(this).attr("src","/img/twitter/fav.png")}),$(".twitter_retweet").off("mouseover").on("mouseover",function(){$(this).attr("src","/img/twitter/retweet_hover.png")}),$(".twitter_retweet").off("mouseover").on("mouseout",function(){$(this).attr("src","/img/twitter/retweet.png")}),$(".twitter_unfav").off("mouseover").on("mouseover",function(){$(this).attr("src","/img/twitter/fav_hover.png")}),$(".twitter_unfav").off("mouseover").on("mouseout",function(){$(this).attr("src","/img/twitter/fav_on.png")}),$(".twitter_unretweet").off("mouseover").on("mouseover",function(){$(this).attr("src","/img/twitter/retweet_hover.png")}),$(".twitter_unretweet").off("mouseover").on("mouseout",function(){$(this).attr("src","/img/twitter/retweet_on.png")})}function bind_hover_shades(){$(".post").off("mouseenter").mouseenter(function(){$(this).addClass("post_hover"),$(this).find(".actions").first().show(),$(this).find(".del-post").show()}),$(".post").off("mouseleave").mouseleave(function(){$(this).removeClass("post_hover"),$(this).find(".actions").first().hide(),$(this).find(".del-post").hide()}),$(".comment").off("mouseenter").mouseenter(function(){$(this).addClass("comment_hover"),$(this).closest(".post").removeClass("post_hover"),$(this).find(".actions").first().show()}),$(".comment").off("mouseleave").mouseleave(function(){$(this).removeClass("comment_hover"),$(this).closest(".post").addClass("post_hover"),$(this).find(".actions").first().hide()}),$(".wideCommentBox").off("mouseenter").mouseenter(function(){$(this).find(".collapseButton").first().show()}),$(".wideCommentBox").off("mouseleave").mouseleave(function(){$(this).find(".collapseButton").first().hide()}),$(".reply").off("mouseenter").mouseenter(function(){$(this).addClass("reply_hover"),$(this).closest(".comment").removeClass("comment_hover"),$(this).find(".actions").first().show()}),$(".reply").off("mouseleave").mouseleave(function(){$(this).removeClass("reply_hover"),$(this).closest(".comment").addClass("comment_hover"),$(this).find(".actions").first().hide()})}function load_post_bindings(){$("a").tooltip(),bind_hover_shades(),$("#newp").off("focusin").focusin(function(){lastURL="",$(".update").addClass("upd-exp"),$(".control").show(),postPaused=!0}),$(".reply_box").off("input propertychange").on("input propertychange",function(a){load_tweet(a.target),$(this).height("20px"),$(this).outerHeight()<this.scrollHeight&&$(this).height(this.scrollHeight),postPaused=!0,commentPaused=!0}),$("#newp").off("input propertychange").on("input propertychange",function(a){load_tweet(a.target)}),$(".reply_box").off("focusin").focusin(function(){if(lastURL="",$(this).height("20px"),$(this).outerHeight()<this.scrollHeight&&$(this).height(this.scrollHeight),""===$(this).val()){var a=$(this).closest(".post_content"),b=a.find("#author").val(),c="@"+$("#user").val();$.trim(b)!=$.trim(c)&&$(this).val(b);var d=$(this).val().length,e=256-d,f=$(this).parent().parent().find("#remainC");f.html(e.toString()),256==e?f.parent().css("display","none"):e>50?(f.parent().css("display","block"),f.css("color","green")):(f.parent().css("display","block"),f.css("color","red"))}postPaused=!0,commentPaused=!0});var a=-1;$("#ctweet").off("click").click(function(){$(this).closest(".reply_pane").find(".reply_box").focus()}),$(".reply_box").off("focusout").focusout(function(){var b=$(this),c=$(this).closest(".reply_pane");a=setTimeout(function(){var a=c.find("#author").val();if(b.val()==a){b.val("");var d=b.val().length,e=256-d,f=b.parent().parent().find("#remainC");f.html(e.toString()),256==e?f.parent().css("display","none"):e>50?(f.parent().css("display","block"),f.css("color","green")):(f.parent().css("display","block"),f.css="red"),resumeCommentVotes()}},1e3)}),$(".reply_box").off("keypress").on("keypress",function(a){13!=a.keyCode||a.shiftKey||(a.preventDefault(),a.stopPropagation(),new_comment(a.target))}),attachTypeAhead(".newc, #newp",$("#spot_id").val().toLowerCase())}function setup_live_stream(a){$("#live_stream").mCustomScrollbar({theme:"dark-thin",autoHideScrollbar:!0,scrollInertia:0,callbacks:{onTotalScroll:function(){loadingStream||(streamsLoaded+=20,socket.emit("live_stream",streamsLoaded),loadingStream=!0)},onTotalScrollOffset:100}}),$.mobile===!0&&$("#live_stream").mCustomScrollbarMobile("vertical",200,5),$("#live_stream").mCustomScrollbar("scrollTo",Math.abs(parseInt(a))),$("a").tooltip()}function highlight(a){var b=$("#"+a);b.finish();var c=b.css("backgroundColor");b.css("backgroundColor","#ffffca").animate({backgroundColor:c},2500)}function animateScroll(a,b){$("html,body").animate({scrollTop:a.offset().top-$(".top_bar").height()-80},400,function(){highlight(b);var c=a.find(".newc");if(c.length)c.focus();else{c=a.parent().parent().find(".newc");var d=a.find("#author").val();c.focus(),c.val(d)}})}function scrollAndHighlight(a){if(void 0===a||"undefined"==a)return void handle_alert("Can't find post! May have been deleted");var b=$("#"+a);return 0===b.length?socket.emit("getPost",{post:a}):b.is(":visible")?animateScroll(b,a):showComments("#"+a,function(){animateScroll(b,a)}),!1}function getRepString(a){return a?(a+="",1e3>a?a:1e4>a?a.charAt(0)+","+a.substring(1):1e6>a?(a/1e3).toFixed(a%1e3!==0)+"K":(a/1e6).toFixed(a%1e6!==0)+"M"):0}function populateImageLinkInPost(a){$("#newp").val($("#newp").val()+" "+a.shortURL+" "),check_lengthP(),load_tweet($("#newp")),$("#newp").focus()}function openImageModal(){$("#uploadImageInput").val(""),$(".uploading-img").hide(),$("#uploadImageModal").modal("show")}function openPostImageModal(){return"false"==check_auth()?(openLoginModal(),!1):(openImageModal(),void(uploadImageFormCallback=populateImageLinkInPost))}function openLogoUploadModal(){openImageModal(),uploadImageFormCallback=function(a){$("img.spot_image").attr("src",""),$("img.spot_image").attr("src",a.url),$('input[name="old_logo"]').val(a.url)}}function openWallpaperUploadModal(){openImageModal(),uploadImageFormCallback=function(a){$("body").css({background:"url("+a.url+") no-repeat center center fixed ",backgroundSize:"cover"}),$('input[name="old_wallpaper"]').val(a.url)}}function afterSocketMessage(a){load_post_bindings(),"votes"==getSortingOrder()&&(postPaused=!0),initEmbdededContent("div#post_divs"),updateTimestamps(),a.numPosts&&$("#post_count").html("<strong>"+getRepString(a.numPosts)+"</strong>"),a.reach?update_reach(a.reach):get_reach()}function renderHTML(a,b){b.clockDrift=serverClientClockDrift,jade.render(document.getElementById("latest"),a,b);var c=$("#latest").html();return $("#latest").html(""),c}function checkStream(a){if(a&&$("#live_stream").is(":visible")){var b=renderHTML("tweet",a);updateLiveStream(b)}}function notify(a,b,c,d,e){var f="<strong>"+a+"</strong> ",g='<div class="notif-subject"><strong>'+a+"</strong> ";"vote"===e?(f+="voted on your post",g+="voted on your post</div>"):"comment"===e?(f+="commented on your post",g+='commented on your post:</div><div class="notif-content"><em>'+b+"</em></div>"):"mention"===e&&(f+="mentioned you",g+='mentioned you:</div><div class="notif-content"><em>'+b+"</em></div>");var h="<a data-original-title title>"+g+"</a>",i='<li data-chatId="'+c+'", data-postId="'+d+'", data-predicate="'+e+'" class="unseen">'+h+"</li>";$(i).insertAfter($("#notif-container .notif-header"));var j='openNotification("'+c+'", "'+d+'", "'+e+'")';$("#notif-container .notif-header").next().attr("onclick",j),$(".fixed-notification .text").html(f),$(".fixed-notification").show(),$(".fixed-notification > a").attr("onclick",j),clearTimeout(notifTimeoutID),notifTimeoutID=setTimeout(function(){$(".fixed-notification").hide()},3e3),initNotification(!0)}function reconnectAttempt(){var a=$("#hash").val().toLowerCase(),b=$("#spot_id").val().toLowerCase(),c=getSortingOrder(),d={hash:a,spot_id:b,isLSVisible:$("#live_stream").is(":visible"),sortBy:c,cookie:document.cookie};socket.emit("request",d)}function isPostPage(){return"post"==window.location.pathname.split("/")[1]}function open_crowd_modal(){var a=$("#spot_id").val().toLowerCase();$("#crowdmodal .modal-body").html("Loading..."),$("#crowdmodal").appendTo("body").modal("toggle"),$.get("/"+a+"/modals/crowd").done(function(a){$("#crowdmodal .modal-body").html(a)})}function open_host_modal(){$("#hostmodal").appendTo("body").modal("toggle")}function open_full_invite_modal(){$("#full_invite_modal").appendTo("body").modal("toggle")}function open_invite_modal(){if("false"==check_auth())return openLoginModal(),!1;var a=window!=window.parent;return a?void $("#embededModal").modal("toggle"):void $("#fullInviteModal").appendTo("body").modal("toggle")}function open_help_modal(){$(".help>a").click()}function shorten_tweet(a,b){var c=twttr.txt.getTweetLength(a);if(c>140){for(var d="... #"+$("#hash").val()+" "+$("#short_url").val(),e=1,f=b;c>140;)f=b.substring(0,140-e)+d,e++,c=twttr.txt.getTweetLength(f);return f}return a}function check_lengthC(a){var b=a.target||a,c=$(b).val().length,d=256-c,e=$(b).parents(".reply_container").find("#remainC");e.html(d.toString()),256==d?e.parents(".tweet_box").hide():d>50?(e.parents(".tweet_box").show(),e.css("color","green")):(e.parents(".tweet_box").show(),e.css("color","red"))}function check_lengthI(){var a=($("#invite").val().length,$("#invite").val()+" #"+$("#hash").val()+" "+$("#short_url").val());a=shorten_tweet(a,$("#invite").val()),$("#ipreview").html(parse_tweet(a))}function check_lengthP(){var a=$("#newp").val().length,b=256-a;$("#remainP").html(b.toString()),b>50?$("#remainP").css("color","green"):$("#remainP").css("color","red")}function allowDrop(a){a.preventDefault()}function drag(a){"true"===$(a.target).closest(".tweet").attr("draggable")&&a.dataTransfer.setData("Tweet ID",$(a.target).closest(".tweet").attr("id"))}function getExtUrl(a){var b=twttr.txt.extractUrls(a);if(b&&b.length>0){var c=b[0];-1==c.indexOf("https://")&&-1==c.indexOf("http://")&&(c="http://"+c);var d="link",e=/http.*twitter.com\/.*\/status\/([0-9]+)\/?$/i,f=c.match(e)&&c.match(e)[1];return f&&(d="tweet"),{type:d,url:c,id:f}}return null}function load_tweet(a){var b=getExtUrl($(a).val());if(b){var c=$("#extCnPrw").find(".tweet");if(c.attr("id"))if("tweet"==b.type){var d=c.attr("id").split("/"),e=d[d.length-1];if(e==b.id)return}else if(c.attr("id")==b.url)return;"tweet"==b.type?$.get("/auth/twitter/oembed",{id:b.id},function(b){$(a).parents(".reply_pane").find("#extCnPrw").html(b)}):getExtContentPreview(b.url,function(b,c){$(a).parents(".reply_pane").find("#extCnPrw").html(""),c&&$(a).parents(".reply_pane").find("#extCnPrw").append(c)})}else $(a).parents(".reply_pane").find(".extCnPrw").html("")}function post_drop(a){if("false"==check_auth())return openLoginModal(),!1;a.preventDefault();var b=a.dataTransfer.getData("Tweet ID");if(b){var c=b.split("/")[0];$("#extCnPrw").find(".tweet").remove(),$(a.target).val("@"+c+" you are quoted in my CrowdChat. Would like if you'd join. http://twitter.com/"+b),check_lengthP(a),check_lengthC(a),load_tweet(a.target),postPaused=!0,commentPaused=!0,$(a.target).closest(".reply_pane").find(".control").css("display","block")}else handle_alert({warning:"You can only drag external tweets with blue bird."})}function reply_drop(a){a.preventDefault();var b=a.dataTransfer.getData("Tweet ID");if(b){var c=b.split("/")[0];$(a.target).val("@"+c+" you are quoted in my CrowdChat. Would like if you'd join. http://twitter.com/"+b),check_lengthP(a),check_lengthC(a),load_tweet(a.target),postPaused=!0,commentPaused=!0,$(a.target).outerHeight()<a.target.scrollHeight&&$(a.target).height(a.target.scrollHeight)}}function open_chat_invite(a){if("false"==check_auth())return openLoginModal(),!1;var b="@"+$(a).attr("data-invited-handle"),c="#"+$("#hash").val(),d=parseInt($("#datetime").val(),10),e=parseInt($("#duration").val(),10),f=new Date(d),g=new Date(d+e),h=new Date,i=$("#share_url").val();i=i.replace("https://www.","").replace("https://","").replace("http://www.","").replace("http://","");var j="";j=h>f&&g>h?b+" join us now for LIVE CrowdChat on "+c+" "+i:b+" you are invited as an influencer to "+c+" Crowdchat. Lets connect at "+i,$("#pre_live_invite_modal .twitter_handle").html(b),$("#pre_live_invite_modal textarea").val(j),$("#pre_live_invite_modal").modal("toggle")}function sent_twitter_invite(){var a=$("#pre_live_invite_modal textarea").val(),b=$("#spot_id").val(),c=$("#hash").val();return 0===twttr.txt.extractMentions(a).length?void wide_alert("You should mention at least one person for this invite."):twttr.txt.extractHashtags(a).indexOf(c)<0?void wide_alert("You should include #"+c+" in your tweet."):($.post("",{operation:"invite_audience",tweet_text:a,spot:b}),void $("#pre_live_invite_modal").modal("toggle"))}function fetchUserAutocompleteResults(a,b,c,d){$.get("../"+a+"/participants?search="+encodeURIComponent(c)).done(function(a){a=JSON.parse(a);var c=[];b.closest(".post").find(".hidaut").each(function(){var b=$(this).val().substr(1).toLowerCase();$.each(a,function(d){var e=a[d].screen_name.toLowerCase();e.substr(0,e.length)==b.substr(0,e.length)&&c.push(a[d])})}),a=c.concat(a),d(a)}).fail(function(){d([])})}function userTemplate(a){var b=new RegExp("("+this.queryParam+")","gi"),c="@"+a.screen_name,d="";"twitter"==a.type&&(d='<i class="fa fa-twitter" style="width:16px; height:16px; color:rgb(0,172,237)"></i>&nbsp');var e='<span class="hidden-xs-inline">'+a.display_name+"</span> ",f="<i>"+c.replace(b,"<strong>$1</strong>")+"</i>";return d+e+f}function addAtPrefix(a){return"$1@"+a.screen_name+" "}function attachTypeAhead(a,b){$(a).each(function(){var a=$(this);a.parent(".textcomplete-wrapper").length<=0&&a.textcomplete([{match:/(^|\s)@(\w*)$/,search:function(c,d){fetchUserAutocompleteResults(b,a,c,d),this.queryParam="@"+c},indexNumber:1,maxcount:5,cache:!0,template:userTemplate,replace:addAtPrefix,footer:"<center>(Press tab to select)</center>"}])})}function openPost(a){a||handle_alert("Can't find post! May have been deleted."),$("div#top_bar").removeClass("in").addClass("collapse"),scrollAndHighlight(a)}function affixLiveStream(){$(document).off("scroll").on("scroll",function(){var a=$(".live_stream_div"),b=$(".live_stream_div_anchor").offset().top-$(".navbar").height()-14,c=a.width(),d=b+a.height(),e=$("#spotContent").offset().top+$("#spotContent").height();e>d&&$(window).scrollTop()>b?(a.addClass("affix").css("top",$(".navbar").height()),a.width(c)):a.removeClass("affix").css({top:"",width:"100%"})})}function onYouTubeIframeAPIReady(){loadChatUrlPreview(),initEmbdededContent("div#post_divs")}function chatHasStarted(){var a=parseInt($("#datetime").val(),10),b=new Date((new Date).getTime()+serverClientClockDrift);return new Date(a)<b}function toggle_edit(a){$(a).attr("data-initialized")||(init_edit_spot(),$(a).attr("data-initialized","true")),"Edit"==$(a).text()?(loadChatEditor(),$(a).text("Cancel"),$(".editActionbar").slideDown("fast"),$(".spotPreLiveDetails").slideUp("fast"),$("#spot-tags").slideUp("fast"),$("#editLogo").show(),$(".toggle-btn").show(),$(".ext-url").children().hide(),$("#editSpotTitle").show(),$("#editSpotDesc").show(),$("#spot-title").hide(),$("#spot-description").hide(),$(".follow-container").hide()):($(a).text("Edit"),$(".editActionbar").slideUp("fast"),$("#spot-tags").slideDown("fast"),$(".spotPreLiveDetails").slideDown("fast"),$("#editLogo").hide(),$(".toggle-btn").hide(),$(".ext-url").children().show(),$(".editContainer > div").slideUp("fast"),$("#editSpotTitle").hide(),$("#editSpotDesc").hide(),$("#spot-title").show(),$("#spot-description").show(),$(".follow-container").show())}function showEditPanel(a){$(".editContainer > form > div").hide(),$(".editContainer").find(a).slideDown("fast")}function delete_spot(a,b){var c="Please type #"+b+" to confirm that you wish to delete the spot.";prompt(c)=="#"+b&&$.post("",{operation:"delete_spot",id:a}).done(function(b){"spot_deleted"==b?socket.emit("refresh_spot",a,b):"permission_denied"==b&&handle_alert({error:"You do not have permission to delete this spot."})}).fail(opfail)}function loadChatEditor(){$.get("/chat/"+$("#archive_id").val()+"?data_only=true",function(a){if(a.short_url){fill_spot_values(a,!1);var b=(new Date).getTime();a.datetime<b&&($("#datepicker").data("DateTimePicker").disable(),$("#timepicker").data("DateTimePicker").disable(),$("#disabledStartDate").show(),isLive=!0)}else handle_alert({error:"Could not reach server, please try again."}),$("input#editSpotSubmit").attr("disabled","")}).fail(function(){handle_alert({error:"Could not reach server, please try again."}),$("input#editSpotSubmit").attr("disabled","")})}function saveChat(){if(validateEditedChat()){var a=$("form#editChat").serializeObject();a.title=$("#editSpotTitle").val(),a.description=$("#editSpotDesc").val(),$.post("/chat/edit?spot="+$("#archive_id").val(),a).done(function(){window.location.hash=""}).fail(function(a){console.error(a)})}}function validateEditedChat(){var a=!0;if(!$("form#editChat").h5Validate("allValid"))return handle_alert({warning:"Please fill in all required fields."}),!1;var b=!0;if($(".tag:input").each(function(){var a=$(this).val().trim();a&&a.length<3&&(handle_alert({warning:"Tags must be 3 or more characters."}),b=!1,showEditPanel(".editTags"),$(this).focus()),b&&(a.indexOf("#")>=0||a.indexOf("@")>=0)&&(handle_alert({warning:"Tags should not contain # or @."}),b=!1,showEditPanel(".editTags"),$(this).focus()),b&&/[\s]/.test(a)&&(handle_alert({warning:"Tags should not contain spaces."}),b=!1,showEditPanel(".editTags"),$(this).focus()),b&&/[^a-zA-Z0-9\s]/.test(a)&&(handle_alert({warning:"Tags should be alphanumeric."}),b=!1,showEditPanel(".editTags"),$(this).focus())}),!b)return!1;if($("#chatTypeVideo").is(":checked")&&!$("input#ext_url").val().match(youtubePatt))return handle_alert({warning:"Please pick a link to Youtube video"}),showEditPanel(".editChatType"),$("input#ext_url").focus(),!1;if(!isLive){var c=new Date($("#datetimelocale").val()).getTime();if(c<(new Date).getTime())return handle_alert({warning:"Chats should be scheduled in future. Please correct the date and time."}),showEditPanel(".editDatetime"),!1}return validateHosts()?a:(showEditPanel(".editHosts"),!1)}function validateHosts(){for(var a=!0,b=0,c=0;c<$(".editHostCard").length;c++){var d=$($(".editHostCard")[c]),e=d.find(".twitter-id").val().trim(),f=d.find(".host-hand").val().trim(),g=d.find(".host-name").val().trim(),h=d.find(".host-desc").val().trim();if(d.find(".field-alert-message").hide(),!e&&(f||g||h)){handle_alert({warning:"Please fill in all required fields."}),a=!1,d.find(".host-hand").focus();break}if(e){if(a&&!f){handle_alert({warning:"Please fill in all required fields."}),a=!1,d.find(".host-hand").focus(),d.find("#missingHost").show();break}if(a&&!g){handle_alert({warning:"Please fill in all required fields."}),a=!1,d.find(".host-name").focus(),d.find("#missingHostName").show();break}if(a&&!h){handle_alert({warning:"Please fill in all required fields."}),a=!1,d.find(".host-desc").focus(),d.find("#missingHostDesc").show();break}}else b++}return a}function archiveSpot(a,b){var c="Please type #"+b+" to confirm that you wish to archive the spot.";prompt(c)=="#"+b&&$.post("",{operation:"archiveSpot",id:a}).done(function(b){"spot_archived"==b?socket.emit("refresh_spot",a,b):"permission_denied"==b&&handle_alert({error:"You do not have permission to delete this spot."})}).fail(function(a){handle_alert({error:a.responseText||"Error occurred when archiving spot."})})}function featureTour(){if("#customize"!==window.location.hash){if("#show-tour"===window.location.hash)return void clientcode.queueMessage("featureTour",function(){$("#siteIntro").modal("show"),window.location.hash=""});if(!$("button.navbar-toggle").is(":visible")&&!("false"===$("#signedIn").val()&&getCookie("introShown")||"true"!==$("#showSiteTour").val()))return"upcoming"===$("#state").val()||"dead"===$("#state").val()||0==$("#post_divs .post").length?void clientcode.queueMessage("featureTour",function(){$("#siteIntroGoToLive").modal("show")}):void clientcode.queueMessage("featureTour",function(){$("#siteIntro").modal("show")})}}function startSiteTour(){postPaused=!0,commentPaused=!0,$("#siteIntro").modal("hide"),bootstro.start(".bootstro",{stopOnBackdropClick:!1,stopOnEsc:!0,finishButton:'<a onclick="bootstro.stop()" class="btn btn-success sitetour-dismiss">Done</a>',onExit:function(){pullUpdates(),clientcode.dequeueMessage(),handle_alert("Check our FAQ for learning more, Thanks!")},onComplete:function(){bootstro.stop()},onStep:function(a){a.idx==$(".bootstro").length-1?$(".sitetour-dismiss").show():$(".sitetour-dismiss").hide()}}),siteTourShown()}function neverShowSiteTour(a){$("#"+a).modal("hide"),siteTourShown(),clientcode.dequeueMessage(),handle_alert("Site tour is always available in FAQ section, Thanks!")}function remindSiteTour(){clientcode.dequeueMessage(),$.post("",{operation:"siteTourRemind"}),createCookie("introShown","true",1)}function siteTourShown(){$.post("",{operation:"siteTourShown"}),createCookie("introShown","true",3650)}function resumePosts(){postPaused=!1,removePullUpdateUI(),postQueue.forEach(function(a){addPost(a)}),postPaused=!1,numMissedPosts=0,$(window).off("scroll").on("scroll",pauseOnScroll),resumeCommentVotes()}function resumeCommentVotes(){commentQueue.forEach(function(a){addComment(a),afterSocketMessage(a)}),commentPaused=!1,applyActions()}function applyActions(){actionQueue.forEach(function(a){"replace_post"==a.op&&replacePost(a)}),actionQueue.forEach(function(a){"replace_comment"==a.op&&replaceComment(a)}),actionQueue.forEach(function(a){a.v&&updateVote(a)}),actionQueue.forEach(function(a){"deletePost"==a.op&&removePost(a)}),processHighlights()}function addPost(a){if(!($("#"+a.page.post.id).length>0)){$(".update").removeClass("upd-exp"),$(".control").hide(),$(".extCnPrw").html(""),$(".reply_box").focusout();var b=renderHTML("contribution",a.page);$("#post_divs").prepend(b),checkUpdateLimit(),processHighlights(),set_checkboxes(check_tweet,check_share,check_fbpost)}}function addComment(a){if(!($("#"+a.page.post.id).length>0)){var b=renderHTML("contribution",a.page),c=$("#"+a.post_id);if(c.length>0){var d=c.find(".post_comments");0===d.first().find(".comment").length&&d.first().prepend('<div class="comment_bubble"></div>'),d.first().append(b),checkUpdateLimit(),processHighlights(),set_checkboxes(check_tweet,check_share,check_fbpost)}}}function replaceComment(a){var b=renderHTML("contribution",a.page);$("#"+a.highlight.post).length>0&&($("#"+a.highlight.post).closest(".wideCommentBox").replaceWith(b),load_post_bindings())}function replacePost(a){if($(".reply_box").focusout(),$("#"+a.post_id).length>0){var b=$("#state").val();a.page.state=b;var c=renderHTML("contribution",a.page),d=$("#"+a.post_id).find(".post_comments").first().html();$("#"+a.post_id).replaceWith(c),$("#"+a.post_id).find(".post_comments").first().html(d)}load_post_bindings()}function updateVote(a){var b=a.p,c=a.v,d=a.a;d?$("#"+b+"a-votes").html(c):$("#"+b+"-votes").html(c)}function removePost(a){a.numPosts&&$("#post_count").html("<strong>"+getRepString(a.numPosts)+"</strong>"),a.reach&&update_reach(a.reach),$("#"+a.postID).remove()}function removePullUpdateUI(){$("#infoBox").hide(),$("#updates").val(""),$("#numUpdates").val(""),$("#post_sort_loading").hide(),$("a#sortByDropDown").removeAttr("disabled"),fixURL()}function renderAll(a){var b=parseInt($("#duration").val(),10);if(b&&(a.page.duration=b),removePullUpdateUI(),"all"==a.op){var c=renderHTML("posts",a.page);$("#posts").html(c),""!=lastMessage&&($("#newp").val(lastMessage),$("#newp").focus(),lastMessage="")}afterSocketMessage(a)}function showUpdateAlert(a){var b="s";1==a&&(b=""),$("#updateFetchIcon").removeClass("fa-refresh"),$("#updateFetchIcon").addClass("fa-arrow-down"),$("#infoText").text("Pull "+a+" New Update"+b),$("#infoBox").removeAttr("style"),$("#infoBox").show()}function checkUpdateLimit(){var a=50,b=$(".post").last().find(".comment").length;$(".post").length+$(".comment").length-b>a&&$(".post").last().remove()}function checkMessageChatID(a){var b=$("#spot_id").val();return a&&a.page&&a.page.post&&a.page.post.spot_id&&b==a.page.post.spot_id?void 0:(console.log("update sent to wrong chat!"),void(!a||a.page||a.page.post||a.page.post.spot_id?console.log("no target set!"):console.log("target chat:",a.page.post.spot_id,"this chat:",b)))}function checkMessageNotifications(a){if(console.log("the data",a),!a.page||!a.highlight)return console.log("malformed message notification!");
if(a.page.notify_mention){var b=a.page.post.raw.slice(0,45);45===b.length&&(b+="..."),notify(a.page.notify_mention,b,a.page.post.spot_id,a.page.post.id,"mention")}if(a.page.notify_comment){var b=a.page.post.raw.slice(0,45);45===b.length&&(b+="..."),notify(a.page.notify_comment,b,a.page.post.spot_id,a.page.post.id,"comment")}}function queueMessageHighlight(a){a.highlight?highlightQueue.push(a.highlight.post):console.log("did not recieve highlight:",a)}function new_post(){if(!authed())return!1;var a=$("#newp"),b=$.trim(a.val());if(""===b)return handle_alert({error:"Please no blank messages."});var c=$("#spot_id").val().toLowerCase();a.val("");var d=$("#hash").val(),e=$("#hash").val().toLowerCase(),f=c,g=$("#ptweet").is(":checked"),h=$("#pshare").is(":checked"),i=$("#pfbpost").is(":checked"),j=$("#isPrivate").val(),k="post",l=a.attr("data-urls");a.attr("data-urls","");var m,n=[],o=a.closest(".reply_pane").find("#extCnPrw"),p=o.children();for(m=0;m<p.length;m+=1){var q="tweet";$(p[m]).find(".pExtCon").length>0&&(q="link");var r={type:q,content:$(p[m]).html(),created_date:$(p[m]).attr("createdDate"),posted_by:$(p[m]).attr("posted_by")};$(p[m]).attr("posted_by")&&(r.twitterURL="http://twitter.com/"+$(p[m]).attr("id")),n.push(r)}$.post("",{operation:"add_post",orig:b,parent_id:f,hash:e,spot_id:c,tweet:g,share:h,fbpost:i,content:n,caseHash:d,post_type:k,urls:l,isPrivate:j}).done(function(){check_lengthP()}).fail(opfail),set_checkboxes(g,h,i),resumePosts(),pullUpdates()}function new_comment(a){if(!authed())return!1;a=$(a);var b=a.closest(".post"),c=a.closest(".reply_pane"),d=b.find("#author").val(),e=$.trim(a.val());if(""===e||e===d)return void handle_alert({error:"Please no blank messages."});a.val("");var f=$("#hash").val(),g=$("#hash").val().toLowerCase(),h=$("#spot_id").val().toLowerCase(),i=b.find("#post").val().toLowerCase(),j=c.find("#ctweet").is(":checked"),k=c.find("#share").is(":checked"),l=c.find("#fbpost").is(":checked"),m=$("#isPrivate").val();set_checkboxes(j,k,l),resumeCommentVotes();var n,o=$("#"+i).find("#post_type").val(),p="comment"===o?"reply":"comment",q=[],r=c.find("#extCnPrw"),s=r.children();for(n=0;n<s.length;n+=1){var t={type:"tweet",content:$(s[n]).html(),created_date:$(s[n]).attr("createdDate"),posted_by:$(s[n]).attr("posted_by")};$(s[n]).attr("posted_by")&&(t.twitterURL="http://twitter.com/"+$(s[n]).attr("id")),q.push(t)}$.post("",{operation:"add_post",orig:e,authorph:d,parent_id:i,hash:g,spot_id:h,tweet:j,share:k,fbpost:l,caseHash:f,content:q,post_type:p,isPrivate:m}).done(opdone).fail(opfail)}function unvote(a){return authed()?void $.post("",{operation:"unvote",post:a}).done(opdone).fail(opfail):!1}function upvote(a){if(!authed())return!1;var b=$("#hash").val();$.post("",{operation:"upvote",post:a,hash:b}).done(opdone).fail(opfail)}function chatAction(a,b,c){return authed()?void $.post("",{operation:a,post:b,id:c}).done(opdone).fail(opfail):!1}function likeUnlikePost(a,b,c){return authed()?void $.post("",{operation:a,post:b,fbPost:c}).done(opdone).fail(opfail):!1}function sharePost(a,b){if(!authed())return!1;$("#"+a).find("#post_type").val();$.post("",{operation:"shareFBPost",post:a,fbPostURL:b}).done(opdone).fail(opfail)}function send_feedback(){var a=$("#feedback").val();$("#feedback").val(""),$.post("/monitoring/feedback",{feedback:a+" (Spot: "+$("#hash").val()+")",user_agent:navigator.userAgent}).done(function(a){a||(a={success:"Thank you for the feedback!"}),handle_alert(a)}).fail(opfail)}function commentReply(a){if("active"==mode){var b=$("#"+a),c=b.find(".newc");0===c.length&&(c=b.closest(".post").find(".newc"));var d=$.trim(b.find("#author").val());c.focus(),c.val(d+" ")}else handle_alert({error:"You can only reply while the spot is live."})}function cp(a,b){var c=$("#server").val(),d=$(a).data("copy");b||(d=c+d),$("#clipBoardModal").find("#chatURL").val(d),$("#clipBoardModal").modal("show"),$("#clipBoardModal").find("#chatURL").off("focus").on("focus",function(){$(this).select(),$(this).mouseup(function(a){a.preventDefault()})}),$("#clipBoardModal").off("shown.bs.modal").on("shown.bs.modal",function(){$("#clipBoardModal").find("#chatURL").focus()})}function deletePost(a){var b="Please type DELETE to confirm that you wish to delete this post.",c=prompt(b);c&&"delete"==c.toLowerCase()&&$.post("",{operation:"deletePost",id:a}).done(function(b){"post_deleted"==b?socket.emit("deletePost",a):handle_alert("permission_denied"==b?{error:"You do not have permission to delete this spot."}:{error:b})}).fail(function(a){var b=a.responseText||"Could not reach server, please try again.";handle_alert({error:b})})}function hideComments(a){var b=$(a).parent();b.prevAll().slideUp("slow"),b.slideUp("slow");var c=b.parent().parent().find(".showCommentsButton");c.is(":visible")||c.slideDown();var d=b.parent().parent().find("#post").val(),e=$("#"+d);$("html,body").animate({scrollTop:e.offset().top-$(".top_bar").height()-80},400,function(){c.finish();var a=c.css("backgroundColor");c.css("backgroundColor","#ffffca").animate({backgroundColor:a},2500)})}function showComments(a,b){var c=$(a).closest(".post").find(".post_comments");c.parent().find(".showCommentsButton").slideUp(),c.children().slideDown("slow",function(){b&&b()})}function authed(){return socket.socket.connected&&socket.socket.sessionid==curSession?"false"==check_auth()?(openLoginModal(),!1):!0:(reconnectAttempt(),handle_alert({error:"Could not contact server, please try again..."}),!1)}function opdone(a){resumeCommentVotes(),handle_alert(a)}function opfail(){handle_alert({error:"Could not reach server, please try again."})}var mode=null,curSession,notifTimeoutID,alertTimeoutID,setDateID,serverClientClockDrift=0,loadingPosts=!1,loadingStream=!1,streamsLoaded=40,check_tweet=!1,check_share=!1,check_fbpost=!1,loadedServices={facebook:!1,twitter:!1},lastMessage="",uploadImageFormCallback=null;$(document).ready(function(){var a=$("#serverTime").val();serverClientClockDrift=a-(new Date).getTime(),check_tweet=$("#ptweet").is(":checked"),check_share=$("#pshare").is(":checked"),check_fbpost=$("#pfbpost").is(":checked"),0!==$("div#captain_modal").length&&clientcode.queueMessage("spotCaptain",function(){$("div#captain_modal").modal("toggle"),setTimeout(function(){$("div#captain_modal").modal("hide"),clientcode.dequeueMessage()},3e4)}),"votes"==getSortingOrder()&&(postPaused=!0),$(window).off("scroll").on("scroll",pauseOnScroll);var b=$("#state").val();"upcoming"==b&&$("#spotContent").hide(),checkGetPost(),$("#tabNav a:first").tab("show"),$("#fullInviteModal").on("show.bs.modal",function(){loadContacts("twitter")});$("#hash").val().toLowerCase(),$("#spot_id").val().toLowerCase();resetInviteMessage(),$("#inviteMessage").on("input",function(){var a=100-$("#inviteMessage").val().length;$("#inviteChars").html(a)}),$("form").h5Validate(),get_reach(),populate_count_down(),setDateID=setInterval(set_date,set_date.SET_DATE_INTERVAL),("indefinite"!=$("#period").val()||"dead"==$("#state").val())&&$(".time_box").show();{var c=$("#spot_id").val().toLowerCase();$("#server").val().toLowerCase()}attachTypeAhead("#newp .newc",c),updateTimestamps(),affixLiveStream(),load_post_bindings(),"true"==$("#first_time").val()&&(open_help_modal(),$.post("",{operation:"viewed_help"}).fail(opfail)),$("#spot-description").html()&&$("#spot-description").html(parse_tweet($("#spot-description").html())),"#customize"===window.location.hash&&"dead"!==$("#state").val()&&$("#editButton").click(),loadChatUrlPreview(),initNotification(!0),initFollowUnfollow()});var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){for(a=String(a),b=b||2;a.length<b;)a="0"+a;return a};return function(e,f,g){var h=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(e)||/\d/.test(e)||(f=e,e=void 0),e=e?new Date(e):new Date,isNaN(e))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks["default"]),"UTC:"==f.slice(0,4)&&(f=f.slice(4),g=!0);var i=g?"getUTC":"get",j=e[i+"Date"](),k=e[i+"Day"](),l=e[i+"Month"](),m=e[i+"FullYear"](),n=e[i+"Hours"](),o=e[i+"Minutes"](),p=e[i+"Seconds"](),q=e[i+"Milliseconds"](),r=g?0:e.getTimezoneOffset(),s={d:j,dd:d(j),ddd:h.i18n.dayNames[k],dddd:h.i18n.dayNames[k+7],m:l+1,mm:d(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(m).slice(2),yyyy:m,h:n%12||12,hh:d(n%12||12),H:n,HH:d(n),M:o,MM:d(o),s:p,ss:d(p),l:d(q,3),L:d(q>99?Math.round(q/10):q),t:12>n?"a":"p",tt:12>n?"am":"pm",T:12>n?"A":"P",TT:12>n?"AM":"PM",Z:g?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(r>0?"-":"+")+d(100*Math.floor(Math.abs(r)/60)+Math.abs(r)%60,4),S:["th","st","nd","rd"][j%10>3?0:(j%100-j%10!=10)*j%10]};return f.replace(a,function(a){return a in s?s[a]:a.slice(1,a.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},Date.prototype.format=function(a,b){return dateFormat(this,a,b)},set_date.SET_DATE_INTERVAL=500;var get_reach=function(){var a=$("#spot_id").val().toLowerCase();$.get("/chat/reach",{spot_id:a}).done(function(a){$("#srh").val("<strong>"+getRepString(a.reach)+"</strong>"),$("#spot_reach").html($("#srh").val()),$("#post_count").html(a.post_count)}).fail(function(){})},update_reach=function(a){$("#srh").val("<strong>"+getRepString(a)+"</strong>"),$("#spot_reach").html($("#srh").val())},splitOnLast=function(a,b){return b=a.lastIndexOf(b),0>b?[a]:[a.substr(0,b),a.substr(b)]},rem_cc_twttr_dups=function(a){a=$("<div/>").append(a);var b=[],c=$("<div/>");a.find(".live_stream_feed").each(function(a,d){var e=$(d).attr("data_screen_name").trim(),f=splitOnLast($(d).find(".tweet_text").text(),"#")[0].trim().toLowerCase(),g=(e+":"+f).toLowerCase();b.indexOf(g)<0&&(c.append(d),b.push(g))});var d=c.html();return d||(d=a),d};$(document).on("submit","#uploadImageForm",function(a){a.preventDefault(),$(".uploading-img").show(),$("#uploadImage").attr("disabled","disabled");var b=new FormData;return b.append("imageFile",$("#uploadImageInput")[0].files[0]),$.ajax({type:"POST",url:$(this).attr("action"),data:b,processData:!1,contentType:!1,mimeType:"multipart/form-data",success:function(a){$(".uploading-img").hide(),$("#uploadImage").removeAttr("disabled"),uploadImageFormCallback?uploadImageFormCallback(a):handle_alert({error:"Error occured - failed to set target"}),$("#uploadImageModal").modal("hide"),uploadImageFormCallback=null},error:function(a){$(".uploading-img").hide(),handle_alert({error:a.responseText}),$("#uploadImage").removeAttr("disabled")},dataType:"json"}),!1}),$(document).on("change","#uploadImageInput",function(){return this.files[0].type.indexOf("image/")<0?(handle_alert({error:"Image format is invalid."}),void $("#uploadImage").attr("disabled","disabled")):this.files[0].size>1048576?(handle_alert({error:"Please upload an image smaller than 1MB."}),void $("#uploadImage").attr("disabled","disabled")):void $("#uploadImage").removeAttr("disabled")}),$(document).on("input propertychange","#invite",check_lengthI),$(document).on("input propertychange","#newp",function(){return"false"==$("#signedIn").val()?($(this).blur().val(""),void openLoginModal()):void check_lengthP()}),$(document).on("input propertychange",".newc",function(){return"false"==$("#signedIn").val()?($(this).blur().val(""),void openLoginModal()):void check_lengthC(this)});var lsPausePlay=function(a){"pause"===a?($("#ls-play").show(),$("#ls-pause").hide(),streamPaused=!0):($("#ls-pause").show(),$("#ls-play").hide(),streamPaused=!1,updateLiveStream(streamQueue.join("")),streamQueue.length=0)},throttleThreshold=500,lastUpdateTime=0,throttledFeed=[],updateLiveStream=function(a){if(streamPaused)return streamQueue.unshift(a),void(streamQueue.length>100&&streamQueue.splice(0,streamQueue.length-100));var b=new Date((new Date).getTime()+serverClientClockDrift),c=b-lastUpdateTime;if(throttleThreshold>c)return throttleThreshold*=2,throttleThreshold>5e3&&(throttleThreshold/=2),throttledFeed.unshift(a),void(throttledFeed.length>100&&throttledFeed.splice(0,throttledFeed.length-100));throttleThreshold/=2,500>throttleThreshold&&(throttleThreshold*=2),lastUpdateTime=b,throttledFeed.length>0&&(a+=throttledFeed.join(""),throttledFeed.length=0);var d=$("#live_stream").find(".mCSB_container").css("top"),e=$("#live_stream");e.mCustomScrollbar("destroy"),e.html(rem_cc_twttr_dups(e.prepend(a).html())),e.find(".live_stream_feed:gt(99)").remove(),setup_hover_icons(),setup_live_stream(d)},isLive=!1;$(document).ready(function(){featureTour()});var socket,postQueue=[],postPaused=!1,commentQueue=[],commentPaused=!1,actionQueue=[],actionPaused=!1,streamQueue=[],streamPaused=!1,highlightQueue=[],numMissedPosts=0,activityCache={};$(document).ready(function(){var a=($("#hash").val().toLowerCase(),$("#spot_id").val().toLowerCase(),$("#server").val().toLowerCase());socket=io.connect(a,{secure:"https:"===location.protocol,"log level":3,"match origin protocol":!0}),socket.on("connect",function(){console.log("connected"),reconnectAttempt()}),socket.on("reconnected",function(){console.log("reconnected"),reconnectAttempt()}),socket.on("disconnect",function(){console.log("disconnect")}),socket.on("reconnect_failed",function(){console.log("reconnect fails")}),socket.on("rerequest",function(){console.log("server asked client to rejoin rooms"),reconnectAttempt(),handle_alert("Reconnecting..."),$("#post_sort_loading").show(),postPaused=!1}),socket.on("request_recieved",function(){curSession=socket.socket.sessionid}),socket.on("network_post_sent",function(a){handle_alert(a)}),socket.on("req_refresh",function(a){handle_alert(a)}),socket.on("addTime",function(a){var b=parseInt($("#duration").val(),10)+a;$("#duration").val(b),postQueue.forEach(function(a){a.duration=b}),commentQueue.forEach(function(a){a.duration=b})}),socket.on("updateVote",function(a){a.a||highlight(a.p),actionQueue.push(a),updateVote(a),a.notify&&notify(a.notify,null,a.chatId,a.p,"vote")}),socket.on("getPost",function(a){changeSort("activity");var b=a.page.posts,c=!1;return b.forEach(function(b){b.id==a.highlight.post&&(c=!0),b.posts&&b.posts.forEach(function(b){b.id==a.highlight.post&&(c=!0)})}),c?($('a[data-order="activity"]'),$("a#sortByAnchor").removeAttr("disabled"),$("#post_sort_loading").hide(),void(a.page.posts.length>0?(a.page.paged=!1,a.page.clockDrift=serverClientClockDrift,jade.render(document.getElementById("posts"),"posts",a.page),a.highlight&&a.highlight.post&&scrollAndHighlight(a.highlight.post),postPaused=!0,load_post_bindings(),a.updates&&($("#updates").val(a.updates.join(",")),a.updates.length>0?showUpdateAlert(a.updates.length):$("#infoBox").hide()),$(window).off("scroll").on("scroll",pauseOnScroll),set_checkboxes(check_tweet,check_share,check_fbpost),updateTimestamps()):static_alert("Could not find post, may be deleted or in previous chat."))):void handle_alert({error:"Post not found! The author deleted it."})}),socket.on("add_post",function(a){checkMessageChatID(a),checkMessageNotifications(a),queueMessageHighlight(a),postQueue.push(a),postPaused||!chatHasStarted()?(numMissedPosts+=1,showUpdateAlert(numMissedPosts)):addPost(a),checkStream(a),afterSocketMessage(a)}),socket.on("add_comment",function(a){checkMessageChatID(a),checkMessageNotifications(a),queueMessageHighlight(a),commentQueue.push(a),!commentPaused&&chatHasStarted()&&addComment(a),checkStream(a),afterSocketMessage(a)}),socket.on("replace_comment",function(a){checkMessageChatID(a),actionQueue.push(a),replaceComment(a),set_checkboxes(check_tweet,check_share,check_fbpost),checkStream(a),afterSocketMessage(a),a.highlight&&highlight(a.highlight.post)}),socket.on("replace_post",function(a){checkMessageChatID(a),actionQueue.push(a),replacePost(a),set_checkboxes(check_tweet,check_share,check_fbpost),checkStream(a),afterSocketMessage(a),a.highlight&&highlight(a.highlight.post)}),socket.on("activityCache",function(a){activityCache=a}),socket.on("all",function(a){"votes"!=a.page.sortBy&&postPaused||renderAll(a)}),socket.on("crowd",function(a){var b=renderHTML("crowd",a);$(".crowd_box").html(b),$("#spot_reach").html($("#srh").val()),$("a").tooltip()}),socket.on("hosts",function(a){var b=renderHTML("hosts",a);$(".host_box").html(b),$("a").tooltip()}),socket.on("announce",function(a){$("#alertText").html(a.message),$("#alertBox").removeClass("alert-danger alert-warning alert-success"),$("#alertBox").removeAttr("style"),$("#alertBox").addClass("alert-warning"),$("#alertBox").show(),window.clearTimeout(alertTimeoutID),alertTimeoutID=window.setTimeout(function(){$("#alertBox").stop().fadeTo(500,0).slideUp(500,function(){$(this).stop().hide()})},8e3)}),socket.on("refresh_spot",function(a){console.log("refreshing"),"block"==$("#edit_spot_modal").css("display")&&$("#edit_spot_modal").modal("toggle"),$("#wideAlertText").html(a.message),$("#wideAlertBox").removeAttr("style"),$("#wideAlertBox").show(),window.clearTimeout(alertTimeoutID),alertTimeoutID=window.setTimeout(function(){$("#alertBox").stop().fadeTo(500,0).slideUp(500,function(){a.redirect_url?window.location.replace(a.redirect_url):location.reload(!0),$(this).stop().hide()})},3e3)}),socket.on("deletePost",function(a){a.op="deletePost",actionQueue.push(a),removePost(a)}),$("#live_stream").is(":visible")&&(socket.on("update_stream",checkStream),socket.on("live_stream",function(a){var b=renderHTML("live_stream",a);b.length==streamsLoaded&&(loadingStream=!1);var c=$("#live_stream").find(".mCSB_container").css("top");$("#live_stream").html(rem_cc_twttr_dups(b)),setup_hover_icons(),setup_live_stream(c)}))});